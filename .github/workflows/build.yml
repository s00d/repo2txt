name: Build and Release Tauri App

on:
  workflow_dispatch:

jobs:
  build-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest' # Universal build for both ARM and Intel Macs
            args: '--target universal-apple-darwin'
            os: 'macos'
          - platform: 'ubuntu-22.04' # for Tauri v1 you could replace this with ubuntu-20.04
            args: ''
            os: 'linux'
          - platform: 'windows-latest'
            args: ''
            os: 'windows'
          - platform: 'windows-latest'
            args: '--target i686-pc-windows-msvc'
            suffix: 'windows'

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.4
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
            src-tauri/target/
            C:\Users\runneradmin\.cargo\registry\index\
            C:\Users\runneradmin\.cargo\registry\cache\
            C:\Users\runneradmin\.cargo\git\db\
          key: ${{ runner.os }}-${{ matrix.args }}-${{ hashFiles('Cargo.lock') }}

      - name: Export variable (unix)
        if: matrix.platform != 'windows-latest'
        run: echo "TAURI_SIGNING_PRIVATE_KEY=${{ secrets.TAURI_PRIVATE_KEY }}" >> $GITHUB_ENV
      - name: Export variable (windows)
        if: matrix.platform == 'windows-latest'
        run: echo "TAURI_SIGNING_PRIVATE_KEY=${{ secrets.TAURI_PRIVATE_KEY }}" >> $GITHUB_ENV
        shell: bash

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          # Those targets are only used on macOS runners so it's in an `if` to slightly speed up windows and linux builds.
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || matrix.platform == 'windows-latest' && 'i686-pc-windows-msvc,x86_64-pc-windows-msvc' || '' }}

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04' # This must match the platform value defined above.
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libssl-dev
        # webkitgtk 4.0 is for Tauri v1 - webkitgtk 4.1 is for Tauri v2.
        # You can remove the one that doesn't apply to your app to speed up the workflow a bit.

      - name: Install frontend dependencies
        run: |
          pnpm install

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: v__VERSION__ # the action automatically replaces __VERSION__ with the app version.
          appName: 'repo2txt_${{ matrix.os }}'
          releaseName: 'Release v__VERSION__'
          releaseBody: 'See the assets to download this version and install.'
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}
          includeUpdaterJson: true
          updaterJsonPreferNsis: true
          includeDebug: false
          includeRelease: true

      - name: Create archives for npm package
        run: |
          VERSION=$(grep -E '^version = ' src-tauri/Cargo.toml | cut -d'"' -f2)
          
          if [ "${{ matrix.os }}" == "macos" ]; then
            # macOS: извлекаем бинарник из .app бандла (universal build содержит оба архитектуры)
            APP_BUNDLE=$(find src-tauri/target -name "*.app" -type d | head -1)
            if [ -z "$APP_BUNDLE" ]; then
              APP_BUNDLE=$(find src-tauri/target -name "repo2txt.app" -type d | head -1)
            fi
            if [ -n "$APP_BUNDLE" ]; then
              BINARY="$APP_BUNDLE/Contents/MacOS/repo2txt"
              if [ -f "$BINARY" ]; then
                # Создаем архив для universal (можно использовать для обеих архитектур)
                mkdir -p dist-archive
                cp "$BINARY" dist-archive/repo2txt
                chmod +x dist-archive/repo2txt
                cd dist-archive
                tar -czf "../repo2txt_${VERSION}_universal-apple-darwin.tar.gz" repo2txt
                # Также создаем для конкретных архитектур (npm-package может использовать universal)
                tar -czf "../repo2txt_${VERSION}_x86_64-apple-darwin.tar.gz" repo2txt
                tar -czf "../repo2txt_${VERSION}_aarch64-apple-darwin.tar.gz" repo2txt
                cd ..
              fi
            fi
          elif [ "${{ matrix.os }}" == "linux" ]; then
            # Linux: бинарник в target/release
            TARGET="x86_64-unknown-linux-gnu"
            BINARY="src-tauri/target/release/repo2txt"
            if [ -f "$BINARY" ]; then
              mkdir -p dist-archive
              cp "$BINARY" dist-archive/repo2txt
              chmod +x dist-archive/repo2txt
              cd dist-archive
              tar -czf "../repo2txt_${VERSION}_${TARGET}.tar.gz" repo2txt
              cd ..
            fi
          elif [ "${{ matrix.os }}" == "windows" ]; then
            # Windows: бинарник в target/release
            if [ -n "${{ matrix.args }}" ] && [[ "${{ matrix.args }}" == *"i686"* ]]; then
              TARGET="i686-pc-windows-msvc"
              BINARY="src-tauri/target/i686-pc-windows-msvc/release/repo2txt.exe"
            else
              TARGET="x86_64-pc-windows-msvc"
              BINARY="src-tauri/target/release/repo2txt.exe"
            fi
            if [ -f "$BINARY" ]; then
              mkdir -p dist-archive
              cp "$BINARY" dist-archive/repo2txt.exe
              cd dist-archive
              zip -r "../repo2txt_${VERSION}_${TARGET}.zip" repo2txt.exe
              cd ..
            fi
          fi
        shell: bash

      - name: Get version
        id: get_version
        shell: bash
        run: |
          VERSION=$(grep -E '^version = ' src-tauri/Cargo.toml | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Create tag if not exists
        if: always()
        shell: bash
        run: |
          TAG="${{ steps.get_version.outputs.tag }}"
          if ! git ls-remote --tags origin "$TAG" | grep -q "$TAG"; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag "$TAG" || true
            git push origin "$TAG" || true
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload archives to release
        if: always()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: Release ${{ steps.get_version.outputs.tag }}
          draft: true
          files: |
            repo2txt_*.tar.gz
            repo2txt_*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
